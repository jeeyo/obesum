<!DOCTYPE html>
<html>

<head>
  <!--meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;"-->
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/jquery.datetimepicker.min.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-firestore.js"></script>
  <title>OBESUM</title>
  <style type="text/css">
  .stickyNavBar {
    background-color: #17BEBB;
  }
  .stickyNavBar .nav-link {
    color: #0E7C7B;
  }
  .stickyNavBar .nav-link.active {
    color: #0E7C7B;
    background-color: #b6fce6;
  }
  </style>
</head>

<body style="background-color: #b6fce6;">
  <div id="app" class="container pt-3" style="overflow-x: hidden;">
    <router-view></router-view>
    
    <div id="loadingModal" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-body text-center">
            <div class="spinner-border" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <div><b>{{ LOADING_MODAL_STRING }}</b></div>
            <div class="alert alert-danger" role="alert" v-if="store.state.error != ''">
              {{ store.state.error }}
            </div>
            <div class="alert alert-warning mt-3 mb-0" role="alert">หากหน้าต่างนี้ค้างอยู่นานเกินไป กรุณาคลิก<a href="#" onclick="location.reload()">รีเฟรช</a></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript" src="js/vue.min.js"></script>
  <script type="text/javascript" src="js/vuex.js"></script>
  <script type="text/javascript" src="js/vue-router.min.js"></script>
  <script type="text/javascript" src="js/lodash.min.js"></script>
  <script type="text/javascript" src="js/moment.js"></script>
  <script type="text/javascript" src="js/popper.min.js"></script>
  <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="js/jquery.datetimepicker.full.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/Chart.bundle.min.js"></script>

  <script>

    const DEBUG = false;
    const USERNAME_SUFFIX = '@obesum.xyz';
    const DIET_PLANS = {
      blank: 'กรุณาเลือกวิธีการลดน้ำหนักจากเมนู Diet Plan ด้านล่าง',
      if: 'Intermittent Fasting (IF)',
      lc: 'Low-carb (LC)',
      lf: 'Low-fat (LF)',
    };
    const LOADING_MODAL_STRING = 'กำลังบันทึกข้อมูล';
    const DEFAULT_DOC = {
      diet_plan: 'blank',
      bmi: [0, 0, 0],
      // the name is `fasting_period` but it is actually `eating_period` for IF
      fasting_period: {
        mon: 12,
        tue: 12,
        wed: 12,
        thu: 12,
        fri: 12,
        sat: 12,
        sun: 12,
      },
      if_checks: Array(21).fill().map(n => ({ no_eating: false, no_calories: false })),
      lc_checks: Array(21).fill().map(n => ({ unsaturated_fat_0: '', unsaturated_fat_1: '', saturated_fat: '', protein: '' })),
      lf_checks: Array(21).fill().map(n => ({ carb_with_fiber: '', unsaturated_fat: '', protein: '' })),
      start_diet_on: firebase.firestore.FieldValue.serverTimestamp(),
      update_diet_on: firebase.firestore.FieldValue.serverTimestamp(),
    };
    const IF_FASTING_PERIOD_LENGTH = 16;
    const IF_WEEKS_COLOR_PALETTE = ['#d6cbd3', '#eca1a6', '#bdcebe', '#ada397'];
    const LC_LF_UNSATURED_FAT_RECIPES = ['ชีส', 'ครีมชีส', 'อโวคาโด', 'แมคคาเดเมีย', 'อัลมอนด์', 'น้ำมันมะพร้าว', 'กรีก โยเกิร์ต'];
    const LC_SATURED_FAT_RECIPES = ['หมูสามชั้น', 'ขาหมู', 'เบคอน'];
    const LC_LF_PROTEIN_RECIPES = ['ไข่', 'นม', 'แฮม', 'เนื้อหมู', 'เนื้อไก่', 'ซีฟู้ด', 'เครื่องในสัตว์', 'เต้าหู้', 'ถั่ว'];
    const LF_CARB_WITH_FIBER_RECIPES = ['ข้าวโพด', 'ผลไม้', 'ข้าวกล้อง', 'มันม่วง', 'ขนมปังธัญพืช'];

    firebase.initializeApp({
      apiKey: 'AIzaSyCyumHT-DtyyUULlC-VNfDvKze0PWSzuqQ',
      authDomain: 'obesum-978f6.firebaseapp.com',
      projectId: 'obesum-978f6',
      appId: '1:758254882474:web:6c029dede9e22070658ad3',
      databaseURL: "https://obesum-978f6.firebaseio.com",
    });

    let today = moment();
    let auth = firebase.auth();
    let db = firebase.firestore();

    const store = new Vuex.Store({
      state: {
        user: null,
        doc: null,
        debouncer: null,
        error: '',
      },
      mutations: {
        setUser(state, user) {
          state.user = user;
        },
        setDocument(state, doc) {
          if(state.doc == null) return state.doc = doc;

          if(this.debouncer != null) this.debouncer.cancel();
          this.debouncer = _.debounce(function() {
            $('#loadingModal').modal({
              backdrop: 'static',
              keyboard: false,
              focus: false,
            });

            db.collection('users').doc(state.user.uid).set(doc)
              .then(function() {
                $('#loadingModal').modal('hide');
              })
              .catch(function(error) {
                state.error = error.message;
              });
          }, 200);
          this.debouncer();
        },
      },
      actions: {
        fetchDocument({ commit, state }) {
          return new Promise((resolve, reject) => {
            db.collection('users').doc(state.user.uid).get()
              .then((doc) => {
                let data = doc.data();
                if(typeof data === 'undefined') return;
                state.doc = data;
                resolve();
              })
              .catch((error) => reject(error));
          });
        }
      },
    });

    const Login = {
      template: `
      <div>
        <div class="text-center" v-if="loading">
          <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          <div class="alert alert-warning mt-3 mb-0" role="alert">หากหน้าต่างนี้ค้างอยู่นานเกินไป กรุณาคลิก<a href="#" onclick="location.reload()">รีเฟรช</a></div>
        </div>
        <div v-else>
          <div class="mb-5 text-center">
            <img src="images/splash_logo.png" style="width: 200px; height: 200px;">
            <h1>Login</h1>
          </div>
          <div class="alert alert-danger" role="alert" v-show="error">
            {{ error }}
          </div>
          <form v-on:submit.stop.prevent="login">
            <div class="form-group">
              <label for="login-username">Username</label>
              <input type="text" class="form-control" id="login-username" v-model="username">
            </div>
            <div class="form-group">
              <label for="login-password">Password</label>
              <input type="password" class="form-control" id="login-password" v-model="password">
            </div>
            <div class="form-group">
              <button class="btn btn-primary">Login</button>
            </div>
            <div class="form-group">
              <router-link to="/register">Register a new account</router-link>
            </div>
          </form>
        </div>
      </div>
      `,
      data: function() {
        return {
          username: '',
          password: '',
          loading: false,
          error: '',
        };
      },
      methods: {
        login: function() {
          let that = this;
          this.loading = true;

          auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
          .then(function() {
            auth.signInWithEmailAndPassword(that.username + USERNAME_SUFFIX, that.password)
            .catch(function(error) {
              that.loading = false;
              that.error = error.message;
            });
          })
          .catch(function(error) {
            that.loading = false;
            that.error = error.message;
          });
        },
      },
      created: function() {
        let that = this;
        this.loading = true;
        auth.onAuthStateChanged(function(user) {
          if(user) {
            store.commit('setUser', user);
            store.dispatch('fetchDocument')
              .then(() => router.push({ path: '/profile' }));
          } else that.loading = false;
        });
      },
    };

    const Logout = {
      template: `
      <div>
        <div class="mb-5">
          <h1>Logging out...</h1>
        </div>
        <div class="spinner-border" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      `,
      created: function() {
        auth.signOut()
        .then(function() {
          router.push({ path: '/' });
        });
      },
    };

    const Register = {
      template: `
      <div>
        <div class="mb-5 text-center">
          <img src="images/thanks.png" style="width: 200px; height: 200px;">
          <h1>Register</h1>
        </div>
        <div class="alert alert-danger" role="alert" v-show="error">
          {{ error }}
        </div>
        <form v-on:submit.stop.prevent="register">
          <div class="form-group">
            <label for="register-username">Username</label>
            <input type="text" class="form-control" id="register-username" v-model="username">
          </div>
          <div class="form-group">
            <label for="register-password">Password</label>
            <input type="password" class="form-control" id="register-password" v-model="password">
          </div>
          <div class="form-group">
            <label for="register-name">Name</label>
            <input type="text" class="form-control" id="register-name" v-model="name">
          </div>
          <div class="form-group">
            <label for="register-password">Age</label>
            <input type="number" class="form-control" id="register-age" v-model="age">
          </div>
          <div class="form-group">
            <label for="register-gender">Gender</label>
            <select id="register-gender">
              <option value="m">Male</option>
              <option value="f">Female</option>
            </select>
          </div>
          <div class="form-group">
            <label for="register-height">Height</label>
            <input type="number" class="form-control" id="register-height" v-model="height">
          </div>
          <div class="form-group">
            <label for="register-weight">Weight</label>
            <input type="number" class="form-control" id="register-weight" v-model="weight">
          </div>
          <div class="form-group">
            <button class="btn btn-primary">Register</button>
          </div>
          <div class="form-group">
            <router-link to="/">Already have an account? Login</router-link>
          </div>
        </form>
      </div>
      `,
      data: function() {
        return {
          username: '',
          password: '',
          name: '',
          age: 25,
          gender: 'm',
          height: 160,
          weight: 60,
          error: '',
        };
      },
      methods: {
        register: function() {
          let that = this;

          $('#loadingModal').modal({
            backdrop: 'static',
            keyboard: false,
            focus: false,
          });

          auth.createUserWithEmailAndPassword(this.username + '@obesum.xyz', this.password)
          .then(function(credential) {

            let user = credential.user;
            store.commit('setUser', user);

            db.collection('users').doc(user.uid).set({
              ...{
                name: that.name,
                age: parseInt(that.age),
                gender: that.gender,
                height: parseInt(that.height),
                weight: parseInt(that.weight),
              },
              ...DEFAULT_DOC,
            })
            .then(function() {
              $('#loadingModal').modal('hide');
              store.dispatch('fetchDocument').then(() => router.push({ path: '/profile' }));
            })
            .catch(function(error) {
              $('#loadingModal').modal('hide');
              that.error = error.message;
            });
          })
          .catch(function(error) {
            $('#loadingModal').modal('hide');
            that.error = error.message.replace('email address', 'username');
          });
        },
      },
    };

    const Profile = {
      template: `
      <div>
        <div class="mb-4">
          <h1>Your profile</h1>
        </div>
        <div style="margin-bottom: 200px;">
          <div class="row mb-2">
            <div class="col"><h2>Welcome, {{ doc.name }}</h2></div>
          </div>
          <div class="row mb-2" v-if="user.uid == 'sZEB6laBrURhjpFFt7nNHpTdjbr1'">
            <div class="col"><router-link to="/feedbacks">View feedbacks</router-link></div>
          </div>
          <div class="row">
            <div class="col"><h3>Your BMI</h3></div>
          </div>
          <div class="row">
            <div class="col-6 offset-1"><h4>Start</h4></div>
            <div class="col">{{ startBMI }}</div>
          </div>
          <div class="row">
            <div class="col-6 offset-1"><h4>Week 1</h4></div>
            <div class="col">{{ doc.bmi[0] }}</div>
          </div>
          <div class="row">
            <div class="col-6 offset-1"><h4>Week 2</h4></div>
            <div class="col">{{ doc.bmi[1] }}</div>
          </div>
          <div class="row">
            <div class="col-6 offset-1"><h4>Week 3</h4></div>
            <div class="col">{{ doc.bmi[2] }}</div>
          </div>

          <div class="row mt-3">
            <div class="col"><h3>Your Diet Plan</h3></div>
          </div>
          <div class="text-center">
            {{ DIET_PLANS[doc.diet_plan] }}
          </div>
        </div>

        <div class="stickyNavBar fixed-bottom border-top shadow-lg pt-3 pb-3">
          <div class="container">
            <nav class="nav nav-pills nav-justified">
              <router-link class="nav-item nav-link active" to="/profile">Profile</router-link>
              <router-link class="nav-item nav-link" to="/diet_plan">Diet Plan</router-link>
              <router-link class="nav-item nav-link" to="/info" v-if="doc.diet_plan != 'blank'">Information</router-link>
              <router-link class="nav-item nav-link" to="/settings">Settings</router-link>
            </nav>
          </div>
        </div>

        <div class="modal" tabindex="-1" role="dialog" aria-hidden="true" ref="newWeightInputModal">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-body text-center">
                <div class="form-group">
                  <label for="newWeight"><h4>คุณได้ลดน้ำหนักมาเป็นเวลา {{ dietDaysPassed }} วันแล้ว ตอนนี้น้ำหนักเท่าไรฮะ</h4></label>
                  <input type="number" class="form-control" id="newWeight" v-model="new_weight">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" v-on:click="updateWeight">Submit</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal" tabindex="-1" role="dialog" aria-hidden="true" ref="feedbackInputModal">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-body text-center">
                <div class="form-group">
                  <label for="feedback"><h4>คุณได้ลดน้ำหนักมาเป็นเวลา 21 วันแล้ว เราขอ Feedback คุณหน่อยสิ</h4></label>
                  <textarea class="form-control" id="feedback" rows="3" v-model="feedback"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" v-on:click="submitFeedback">Submit</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      `,
      data: function() {
        return {
          new_weight: 0,
          feedback: '',
        };
      },
      methods: {
        updateWeight: function() {
          let that = this;
          let newBMIIndex = this.doc.bmi.findIndex((b) => b == 0);
          if(newBMIIndex == -1) newBMIIndex = 2;

          let bmi = parseInt(this.new_weight) / (this.doc.height * this.doc.height / 10000);
          this.doc.bmi[newBMIIndex] = Math.round((bmi + Number.EPSILON) * 100) / 100;

          if(!DEBUG) this.doc.update_diet_on = firebase.firestore.FieldValue.serverTimestamp();
          else this.doc.update_diet_on = firebase.firestore.Timestamp.fromDate(today.toDate());

          store.commit('setDocument', this.doc);
          $(that.$refs['newWeightInputModal']).modal('hide');

          let start_diet_on_moment = moment.unix(this.doc.start_diet_on.seconds);
          if(today.isSameOrAfter(start_diet_on_moment.add(21, 'days'))) {
            $(this.$refs['feedbackInputModal']).modal({
              backdrop: 'static',
              keyboard: false,
              focus: false,
            });
          }
        },
        submitFeedback: function() {
          let that = this;
          $('#loadingModal').modal({
            backdrop: 'static',
            keyboard: false,
            focus: false,
          });

          db.collection('feedbacks').add({
            doc: that.doc,
            user: {
              uid: that.user.uid,
              username: that.username,
            },
            feedback: that.feedback,
            submitted_on: firebase.firestore.FieldValue.serverTimestamp(),
          })
            .then(function() {
              db.collection('users').doc(that.user.uid).update({
                ...{
                  weight: parseInt(that.new_weight),
                },
                ...DEFAULT_DOC,
              })
                .then(function() {
                  store.dispatch('fetchDocument').then(function() {
                    $(that.$refs['feedbackInputModal']).modal('hide');
                    $('#loadingModal').modal('hide');
                  });
                });
            })
            .catch((error) => console.log(error));
        },
      },
      computed: {
        username: function() {
          return this.user.email.slice(0, 0 - USERNAME_SUFFIX.length);
        },
        startBMI: function() {
          let bmi = this.doc.weight / (this.doc.height * this.doc.height / 10000);
          return Math.round((bmi + Number.EPSILON) * 100) / 100;
        },
        currentBMI: function() {
          let latestBMI = this.doc.bmi.find((b) => b != 0);
          if(typeof latestBMI === 'undefined') return this.startBMI;
          return latestBMI;
        },
        dietPlan: function() {
          return DIET_PLANS[this.doc.diet_plan];
        },
        lastUpdated: function() {
          return moment.unix(this.doc.update_diet_on.seconds).format();
        },
        dietDaysPassed: function() {
          return today.diff(moment.unix(this.doc.start_diet_on.seconds), 'days');
        },
        ...Vuex.mapState(['user', 'doc']),
      },
      mounted: function() {
        if(this.doc.diet_plan == 'blank') return;

        let update_diet_on_moment = moment.unix(this.doc.update_diet_on.seconds);
        if(today.isSameOrAfter(update_diet_on_moment.add(7, 'days'))) {
          $(this.$refs['newWeightInputModal']).modal({
            backdrop: 'static',
            keyboard: false,
            focus: false,
          });
        }
      },
    };

    const EditProfile = {
      template: `
      <div>
        <div class="mb-5 text-center">
          <img src="images/thanks.png" style="width: 200px; height: 200px;">
          <h1>Edit profile</h1>
        </div>
        <div class="alert alert-danger" role="alert" v-show="error">
          {{ error }}
        </div>
        <div class="alert alert-danger" role="alert" v-show="error">
          {{ error }}
        </div>
        <form v-on:submit="edit">
          <div class="form-group">
            <label for="edit-profile-username">Username</label>
            <input type="text" class="form-control" id="edit-profile-username" v-model="username" disabled>
          </div>
          <div class="form-group">
            <label for="edit-profile-name">Name</label>
            <input type="text" class="form-control" id="edit-profile-name" v-model="name">
          </div>
          <div class="form-group">
            <label for="edit-profile-password">Age</label>
            <input type="number" class="form-control" id="edit-profile-age" v-model="age">
          </div>
          <div class="form-group">
            <label for="edit-profile-gender">Gender</label>
            <select id="edit-profile-gender" disabled>
              <option value="m">Male</option>
              <option value="f">Female</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-profile-height">Height</label>
            <input type="number" class="form-control" id="edit-profile-height" v-model="height">
          </div>
          <div class="form-group">
            <label for="edit-profile-weight">Weight</label>
            <input type="number" class="form-control" id="edit-profile-weight" v-model="weight">
          </div>
          <div class="form-group">
            <button class="btn btn-primary">Edit</button>
          </div>
          <div class="form-group">
            <router-link to="/settings">Back</router-link>
          </div>
        </form>
      </div>
      `,
      data: function() {
        return {
          name: store.state.doc.name,
          age: store.state.doc.age,
          gender: store.state.doc.gender,
          height: store.state.doc.height,
          weight: store.state.doc.weight,
          error: '',
        };
      },
      computed: {
        username: function() {
          return this.user.email.slice(0, 0 - USERNAME_SUFFIX.length);
        },
        ...Vuex.mapState(['user', 'doc']),
      },
      methods: {
        edit: function() {
          this.doc.name = this.name;
          this.doc.age = this.age;
          this.doc.gender = this.gender;
          this.doc.height = this.height;
          this.doc.weight = this.weight;

          store.commit('setDocument', this.doc);
          router.push({ path: '/settings' });

          return false;
        },
      },
    };

    const DietPlan = {
      template: `
      <div>
        <div class="mb-5">
          <h1>{{ doc.diet_plan == 'blank' ? 'Diet Plan' : DIET_PLANS[doc.diet_plan] }}</h1>
        </div>
        <div style="margin-bottom: 200px;" v-if="doc.diet_plan == 'blank'">
          <div class="card-deck">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">IF (Intermittent Fasting)</h5>
                <p class="card-text">การกินแบบจำกัดช่วงเวลา ซึ่งมีช่วงที่กินได้ [eating] กับ กินไม่ได้ [fasting] จะทำให้การเผาผลาญเปลี่ยนไป</p>
              </div>
              <div class="card-footer">
                <a href="#" class="btn btn-primary" v-on:click="dietPlanSelect('if')">Select</a>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <h5 class="card-title">LC (Low Carbohydrate)</h5>
                <p class="card-text">การกินอาหารแบบกินคาร์โบไฮเดรตให้น้อยลง แต่อาจจะกินไขมันมากขึ้นแทน (ketogenic)</p>
              </div>
              <div class="card-footer">
                <a href="#" class="btn btn-primary" v-on:click="dietPlanSelect('lc')">Select</a>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <h5 class="card-title">LF (Low Fat)</h5>
                <p class="card-text">รูปแบบการกินที่เรากินไขมันให้น้อย แต่กินคาร์โบไฮเดรตที่มีไฟเบอร์เยอะขึ้น</p>
              </div>
              <div class="card-footer">
                <a href="#" class="btn btn-primary" v-on:click="dietPlanSelect('lf')">Select</a>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 200px;" v-else-if="doc.diet_plan == 'if'">
          <div class="row">
            <canvas ref="ifChart" width="300" height="300" style="width: 300px !important; height: 300px !important;"></canvas>
          </div>
          <div class="row mt-3">
            <div class="w-100 overflow-auto">
              <table class="table table-bordered mb-0 text-center">
                <thead>
                  <tr>
                    <th></th>
                    <th v-for="(d, i) in twentyOneDays" :style="{ backgroundColor: IF_WEEKS_COLOR_PALETTE[Math.floor(i / 7)] }">
                      <div>{{ d.format('ddd') }}</div>
                      <div>{{ d.format('DD') }}</div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th style="white-space: nowrap;">
                      <div>คุณได้กินอาหาร</div>
                      <div>ตามเวลา IF ไหม</div>
                      <div>
                        <a href="#" ref="whyNoEating" data-toggle="tooltip" data-placement="bottom" title="<ul class='list-unstyled'><li>คุณกินอาหารในช่วงเวลา 8 ชม.</li><li>คุณไม่ได้กินอาหารเป็นเวลา 16 ชม.</li></ul>" onclick="return false;">Why?</a>
                      </div>
                    </th>
                    <td class="align-middle" v-for="(d, i) in twentyOneDays" :style="{ backgroundColor: IF_WEEKS_COLOR_PALETTE[Math.floor(i / 7)] }">
                      <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" :id="'no_eating-' + i" :disabled="shouldBeDisabled(d)" v-on:change="ifTick" v-model="doc.if_checks[i]['no_eating']">
                        <label class="custom-control-label" :for="'no_eating-' + i"></label>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <th style="white-space: nowrap;">
                      <div>คุณได้กินน้ำ No cal</div>
                      <div>ในเวลา IF ไหม</div>
                      <div>
                        <a href="#" ref="whyNoCal" data-toggle="tooltip" data-placement="bottom" title="<ul class='list-unstyled'><li>ในระยะเวลา 16 ชม.ที่ไม่กินอาหาร คุณได้ดื่มน้ำ No cal</li><li>การกินน้ำจะช่วยให้คุณควบคุมความหิวได้ดีขึ้น</li><li>หลีกเลี่ยงน้ำอัดลม no cal หรือน้ำ no cal ที่มีโซเดียมสูง</li></ul>" onclick="return false;">Why?</a>
                      </div>
                    </th>
                    <td class="align-middle" v-for="(d, i) in twentyOneDays" :style="{ backgroundColor: IF_WEEKS_COLOR_PALETTE[Math.floor(i / 7)] }">
                      <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" :id="'no_calories-' + i" :disabled="shouldBeDisabled(d)" v-on:change="ifTick" v-model="doc.if_checks[i]['no_calories']">
                        <label class="custom-control-label" :for="'no_calories-' + i"></label>
                      </div>
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <th></th>
                    <td class="align-middle" v-for="i in 3" colspan="7">
                      <b>Week {{ i }}</b>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 200px;" v-else-if="doc.diet_plan == 'lc'">
          <div class="row mt-3">
            <div class="w-100 overflow-auto">
              <table class="table table-bordered mb-0 text-center">
                <thead>
                  <tr>
                    <th></th>
                    <th></th>
                    <th>Unsaturated Fat (52.5%)</th>
                    <th>Saturated Fat (12.5%)</th>
                    <th>Protein (20%)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(d, i) in twentyOneDays" :style="{ backgroundColor: IF_WEEKS_COLOR_PALETTE[Math.floor(i / 7)] }">
                    <td class="align-middle" rowspan="7" v-if="i % 7 == 0">
                      <div style="transform: rotate(270deg);"><b>Week {{ (i / 7) + 1 }}</b></div>
                    </td>
                    <th class="align-middle">
                      <div>{{ d.format('ddd') }}</div>
                      <div>{{ d.format('DD') }}</div>
                    </th>
                    <td class="align-middle">
                      <button type="button" class="btn btn-link" :disabled="shouldBeDisabled(d)" v-on:click="lcLfShowRecipeModal(LC_LF_UNSATURED_FAT_RECIPES, i , 'unsaturated_fat_0')">
                        {{ doc.lc_checks[i]['unsaturated_fat_0'] == '' ? 'Add' : doc.lc_checks[i]['unsaturated_fat_0'] }}
                      </button>
                      <button type="button" class="btn btn-link" :disabled="shouldBeDisabled(d)" v-on:click="lcLfShowRecipeModal(LC_LF_UNSATURED_FAT_RECIPES, i , 'unsaturated_fat_1')">
                        {{ doc.lc_checks[i]['unsaturated_fat_1'] == '' ? 'Add' : doc.lc_checks[i]['unsaturated_fat_1'] }}
                      </button>
                    </td>
                    <td class="align-middle">
                      <button type="button" class="btn btn-link" :disabled="shouldBeDisabled(d)" v-on:click="lcLfShowRecipeModal(LC_SATURED_FAT_RECIPES, i, 'saturated_fat')">
                        {{ doc.lc_checks[i]['saturated_fat'] == '' ? 'Add' : doc.lc_checks[i]['saturated_fat'] }}
                      </button>
                    </td>
                    <td class="align-middle">
                      <button type="button" class="btn btn-link" :disabled="shouldBeDisabled(d)" v-on:click="lcLfShowRecipeModal(LC_LF_PROTEIN_RECIPES, i, 'protein')">
                        {{ doc.lc_checks[i]['protein'] == '' ? 'Add' : doc.lc_checks[i]['protein'] }}
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 200px;" v-else-if="doc.diet_plan == 'lf'">
          <div class="row mt-3">
            <div class="w-100 overflow-auto">
              <table class="table table-bordered mb-0 text-center">
                <thead>
                  <tr>
                    <th></th>
                    <th></th>
                    <th>Carb with fiber (60%)</th>
                    <th>Unsaturated Fat (20%)</th>
                    <th>Protein (20%)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(d, i) in twentyOneDays" :style="{ backgroundColor: IF_WEEKS_COLOR_PALETTE[Math.floor(i / 7)] }">
                    <td class="align-middle" rowspan="7" v-if="i % 7 == 0">
                      <div style="transform: rotate(270deg);"><b>Week {{ (i / 7) + 1 }}</b></div>
                    </td>
                    <th class="align-middle">
                      <div>{{ d.format('ddd') }}</div>
                      <div>{{ d.format('DD') }}</div>
                    </th>
                    <td class="align-middle">
                      <button type="button" class="btn btn-link" :disabled="shouldBeDisabled(d)" v-on:click="lcLfShowRecipeModal(LF_CARB_WITH_FIBER_RECIPES, i , 'carb_with_fiber')">
                        {{ doc.lf_checks[i]['carb_with_fiber'] == '' ? 'Add' : doc.lf_checks[i]['carb_with_fiber'] }}
                      </button>
                    </td>
                    <td class="align-middle">
                      <button type="button" class="btn btn-link" :disabled="shouldBeDisabled(d)" v-on:click="lcLfShowRecipeModal(LC_LF_UNSATURED_FAT_RECIPES, i, 'unsaturated_fat')">
                        {{ doc.lf_checks[i]['unsaturated_fat'] == '' ? 'Add' : doc.lf_checks[i]['unsaturated_fat'] }}
                      </button>
                    </td>
                    <td class="align-middle">
                      <button type="button" class="btn btn-link" :disabled="shouldBeDisabled(d)" v-on:click="lcLfShowRecipeModal(LC_LF_PROTEIN_RECIPES, i, 'protein')">
                        {{ doc.lf_checks[i]['protein'] == '' ? 'Add' : doc.lf_checks[i]['protein'] }}
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="stickyNavBar fixed-bottom border-top shadow-lg pt-3 pb-3">
          <div class="container">
            <nav class="nav nav-pills nav-justified">
              <router-link class="nav-item nav-link" to="/profile">Profile</router-link>
              <router-link class="nav-item nav-link active" to="/diet_plan">Diet Plan</router-link>
              <router-link class="nav-item nav-link" to="/info" v-if="doc.diet_plan != 'blank'">Information</router-link>
              <router-link class="nav-item nav-link" to="/settings">Settings</router-link>
            </nav>
          </div>
        </div>

        <div class="modal recipeModal" tabindex="-1" role="dialog" aria-hidden="true" ref="recipeModal">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-body list-group">
                <a href="#" v-for="recipe in lc_lf_recipes" class="list-group-item list-group-item-action" v-on:click="lcLfConfirmRecipe(recipe)">{{ recipe }}</a>
                <div class="list-group-item">
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="พิมพ์ชื่ออาหารที่คุณต้องการได้เลย" v-model="lc_lf_custom_recipe">
                    <div class="input-group-append">
                      <button class="btn btn-outline-secondary" type="button" v-on:click="lcLfConfirmRecipe(lc_lf_custom_recipe)">บันทึก</button>
                    </div>
                  </div>
                </div>
                <a href="#" class="list-group-item list-group-item-action text-danger" v-on:click="lcLfConfirmRecipe('')"><b>เอาออก</b></a>
              </div>
            </div>
          </div>
        </div>
      </div>
      `,
      data: function() {
        return {
          twentyOneDays: [],
          lc_lf_recipes: [],
          lc_lf_eat_info: [0, ''],
          lc_lf_custom_recipe: '',
        };
      },
      created: function() {
        this.twentyOneDays = this.doc.diet_plan != 'blank' ? Array(21).fill().map((n, i) => moment.unix(this.doc.start_diet_on.seconds).add(i, 'days')) : [];
      },
      methods: {
        dietPlanSelect: function(dp) {
          this.doc.diet_plan = dp;

          if(!DEBUG) {
            this.start_diet_on = firebase.firestore.FieldValue.serverTimestamp();
            this.update_diet_on = firebase.firestore.FieldValue.serverTimestamp();
          } else {
            this.doc.start_diet_on = firebase.firestore.Timestamp.fromDate(today.toDate());
            this.doc.update_diet_on = firebase.firestore.Timestamp.fromDate(today.toDate());
          }
          this.twentyOneDays = Array(21).fill().map((n, i) => moment.unix(this.doc.start_diet_on.seconds).add(i, 'days'));
          store.commit('setDocument', this.doc);
        },
        ifTick: function() {
          store.commit('setDocument', this.doc);
        },
        lcLfShowRecipeModal: function(recipes, idx, type) {
          this.lc_lf_eat_info = [idx, type];
          this.lc_lf_recipes = recipes;
          this.lc_lf_custom_recipe = '';
          $(this.$refs['recipeModal']).modal();
        },
        lcLfConfirmRecipe: function(recipe) {
          let idx = this.lc_lf_eat_info[0];
          let type = this.lc_lf_eat_info[1];

          if(this.doc.diet_plan == 'lc')
            this.doc.lc_checks[idx][type] = recipe;
          else if(this.doc.diet_plan == 'lf')
            this.doc.lf_checks[idx][type] = recipe;

          store.commit('setDocument', this.doc);
          $(this.$refs['recipeModal']).modal('hide');
        },
        shouldBeDisabled: function(d) {
          return d.isSameOrBefore(today, 'day') ? false : true;
        },
        updateDOM: function() {
          var that = this;

          if(this.doc.diet_plan == 'if')
          {
            $(this.$refs['whyNoEating']).tooltip({ html: true });
            $(this.$refs['whyNoCal']).tooltip({ html: true });

            let canvas = this.$refs['ifChart'];
            let ctx = canvas.getContext('2d');

            (function pie_drawer() {

              ctx.setTransform(1, 0, 0, 1, 0, 0);
              ctx.fillStyle = 'white';
              ctx.fill();

              let myDoughnutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                  datasets: [{
                    data: [24 - IF_FASTING_PERIOD_LENGTH, IF_FASTING_PERIOD_LENGTH],
                    backgroundColor: ['#ed553b', '#3caea3'],
                  }],
                },
                options: {
                  animation: false,
                  rotation: ((that.doc.fasting_period[today.format('ddd').toLowerCase()] / 12) + 1.5) * Math.PI,
                  legends: { display: false },
                  responsive: true,
                  maintainAspectRatio: false,
                  events: [],
                },
              });

              // let's start with today's fasting period
              let next_period_start = moment();
              next_period_start.hours(that.doc.fasting_period[today.format('ddd').toLowerCase()]);
              next_period_start.minutes(0);
              next_period_start.seconds(0);
              next_period_start.milliseconds(0);

              let next_period_verb = 'กิน';

              // now i'm fasting
              if(moment().isSameOrAfter(next_period_start) && moment().isBefore(moment(next_period_start).add(8, 'hours'))) {
                next_period_start.add(8, 'hours');
                next_period_verb = 'ฟาสต์';
              }
              // i'm done fasting for today
              else if(moment().isAfter(next_period_start) && moment().isAfter(moment(next_period_start).add(8, 'hours'))) {
                next_period_start.add(1, 'days').hours(that.doc.fasting_period[moment(today).add(1, 'days').format('ddd').toLowerCase()]);
                next_period_verb = 'กิน';
              }

              let notification_time = moment(next_period_start).subtract(5, 'minutes');
              if(moment().hours() == notification_time.hours() &&
                moment().minutes() == notification_time.minutes() &&
                moment().seconds() == notification_time.seconds())
              {
                try {
                  var notification = new Notification('แจ้งเตือนเวลา' + next_period_verb, {
                    body: 'อีก 5 นาทีจะถึงเวลา' + next_period_verb,
                  });
                } catch (err) {
                  alert('Notification API error: ' + err);
                }
              }

              let width = parseInt($(canvas).css('width').slice(0, -2));
              let height = parseInt($(canvas).css('height').slice(0, -2));
              let radius = height / 2;
              ctx.translate(width / 2, (height / 2) + 7);

              let hours_to_next_period = Math.abs(moment().diff(next_period_start, 'hours'));
              let minutes_to_next_period = Math.abs(moment().diff(next_period_start, 'minutes')) - (hours_to_next_period * 60) + 1;

              // 24-hour clock hand
              let hour = (moment().hours() * Math.PI / 12) +
                (moment().minutes() * Math.PI / (12 * 60)) +
                (moment().seconds() * Math.PI / (720 * 60));
              ctx.beginPath();
              ctx.lineWidth = 3;
              ctx.strokeStyle = '#173f5f';
              ctx.moveTo(0, 0);
              ctx.rotate(hour);
              ctx.lineTo(0, -radius * 0.70);
              ctx.stroke();
              ctx.rotate(-hour);

              // 24-hour clock face
              ctx.font = '14pt Arial';
              ctx.textAlign = 'center';
              ctx.fillStyle = 'white';
              for(let i = 1; i <= 24; i++) {
                let ang = i * Math.PI / 12;
                ctx.rotate(ang);
                ctx.translate(0, -radius * 0.85);
                ctx.rotate(-ang);
                ctx.fillText(`${i}`, 0, 0);
                ctx.rotate(ang);
                ctx.translate(0, radius * 0.85);
                ctx.rotate(-ang);
              }

              // center text
              ctx.font = '14pt Arial';
              ctx.textAlign = 'center';
              ctx.fillStyle = '#20639b';
              ctx.fillText('อีก', 0, 0 - 21 - 3 - 6);
              ctx.fillText(hours_to_next_period + ' ชั่วโมง', 0, 0 - 7 - 3);
              ctx.fillText(minutes_to_next_period + ' นาที', 0, 0 + 7 + 6);
              ctx.fillText('จะถึงเวลา' + next_period_verb, 0, 0 + 14 + 14 + 6);

              setTimeout(pie_drawer.bind(this), 1000);
            })();
          }
        },
      },
      computed: Vuex.mapState(['user', 'doc']),
      mounted: function() {
        this.$nextTick(this.updateDOM);
      },
      updated: function() {
        this.updateDOM();
      },
    };

    const Information = {
      template: `
      <div>
        <div class="mb-5">
          <h1>{{ doc.diet_plan == 'blank' ? 'Diet Plan' : DIET_PLANS[doc.diet_plan] }} Information</h1>
        </div>
        <div style="margin-bottom: 200px;" v-if="doc.diet_plan == 'if'">
          <div class="row mb-2">
            <div class="col"><h2>ช่วงเวลากิน</h2></div>
          </div>
          <div class="row" v-for="dow in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']" :key="dow">
            <div class="col-4">
              <h3>{{ dow }}</h3>
            </div>
            <div class="col">
              <ul class="pagination">
                <li class="page-item">
                  <a class="page-link" href="#" v-on:click="decreaseHour(dow)">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                <li class="page-item disabled">
                  <a class="page-link" href="#">
                    {{ fastingPeriodStart(dow) }}.00 - {{ fastingPeriodEnd(dow) }}.00
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="#" v-on:click="increaseHour(dow)">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col">คุณจะรู้สึกหิวจนท้องแสบ....ถ้า</div>
          </div>
          <div class="row">
            <div class="col">
              <ul>
                <li>exercise ตอน fasting จะหิวกว่าเดิม</li>
                <li>กินอาหารไม่มีประโยชน์ เช่น junk food</li>
              </ul>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 200px;" v-if="doc.diet_plan == 'lc'">
          <div class="row">
            <div class="col"><h3>Side effects</h3></div>
          </div>
          <div class="row">
            <div class="col-3 text-center">
              <img style="width: 50px;" src="images/lc_urticaria.png">
            </div>
            <div class="col-3 text-center">
              <img style="width: 50px;" src="images/lc_nausea.png">
            </div>
            <div class="col-3 text-center">
              <img style="width: 50px;" src="images/lc_dizziness.png">
            </div>
            <div class="col-3 text-center">
              <img style="width: 50px;" src="images/lc_highstrung.png">
            </div>
          </div>
          <div class="row">
            <div class="col-3 text-center">ผื่นแดง</div>
            <div class="col-3 text-center">คลื่นไส้</div>
            <div class="col-3 text-center">วิงเวียนศีรษะ</div>
            <div class="col-3 text-center">หงุดหงิดง่าย</div>
          </div>

          <div style="margin-top: 50px;">
            <div class="row">
              <div class="col"><h3>กลุ่มอาหารที่ต้อง<u class="text-danger">เลี่ยง</u>เพื่อให้น้ำหนักดีขึ้น</h3></div>
            </div>
            <div class="row">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th scope="col">ของเหลว</th>
                    <th scope="col">ผักมีคาร์โบไฮเดรต</th>
                    <th scope="col">ชีส</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>แอลกอฮอล์</td>
                    <td>เห็ด</td>
                    <td>Brick cheese</td>
                  </tr>
                  <tr>
                    <td>คาเฟอีน</td>
                    <td>กระเทียม</td>
                    <td>Mozzarella cheese</td>
                  </tr>
                  <tr>
                    <td>ซอสทั่วไป</td>
                    <td>มะเขือเทศ</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td></td>
                    <td>ฟัก</td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div style="margin-top: 50px;">
            <div class="row">
              <div class="col"><h3>เพิ่มพลัง Keto</h3></div>
            </div>
            <div class="row">
              <div class="col">
                <ul>
                  <li>กินน้ำ 2 ขวด (3-4 ลิตร)</li>
                  <li>ผัก &rarr; บล๊อคโคลี่ / กะหล่ำปลี / ถั่วเขียว / ผักกาด / ผักโขม</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 200px;" v-if="doc.diet_plan == 'lf'">
          <div class="row">
            <div class="col"><h3>กลุ่มอาหารที่ต้อง<u class="text-danger">เลี่ยง</u>เพื่อให้น้ำหนักดีขึ้น</h3></div>
          </div>
          <div class="row">
            <div class="col offset-1">มีคำว่า &quot;Low fat&quot; โดยเฉพาะ &quot;นม&quot;</div>
          </div>
          <div style="margin-top: 50px;">
            <div class="row">
              <div class="col"><h3>เพิ่มพลัง Low-fat</h3></div>
            </div>
            <div class="row">
              <div class="col offset-1">ผักเขียว - ผักโขม, กระเทียม, กะหล่ำปลี</div>
            </div>
          </div>
        </div>

        <div class="stickyNavBar fixed-bottom border-top shadow-lg pt-3 pb-3">
          <div class="container">
            <nav class="nav nav-pills nav-justified">
              <router-link class="nav-item nav-link" to="/profile">Profile</router-link>
              <router-link class="nav-item nav-link" to="/diet_plan">Diet Plan</router-link>
              <router-link class="nav-item nav-link active" to="/info" v-if="doc.diet_plan != 'blank'">Information</router-link>
              <router-link class="nav-item nav-link" to="/settings">Settings</router-link>
            </nav>
          </div>
        </div>
      </div>
      `,
      methods: {
        decreaseHour: function(dow) {
          let newHour = this.doc.fasting_period[dow.toLowerCase()] - 1;
          if(newHour < 0) newHour = 23;
          this.doc.fasting_period[dow.toLowerCase()] = newHour;
          store.commit('setDocument', this.doc);
          return false;
        },
        increaseHour: function(dow) {
          let newHour = this.doc.fasting_period[dow.toLowerCase()] + 1;
          if(newHour > 23) newHour = 0;
          this.doc.fasting_period[dow.toLowerCase()] = newHour;
          store.commit('setDocument', this.doc);
          return false;
        },
        fastingPeriodStart: function(dow) {
          let start = this.doc.fasting_period[dow.toLowerCase()];
          return start < 10 ? `0${start}` : `${start}`;
        },
        fastingPeriodEnd: function(dow) {
          let end = this.doc.fasting_period[dow.toLowerCase()] + (24 - IF_FASTING_PERIOD_LENGTH);
          if(end > 23) end -= 24;
          return end < 10 ? `0${end}` : `${end}`;
        },
      },
      computed: Vuex.mapState(['user', 'doc']),
    };

    const Settings = {
      template: `
      <div>
        <div class="mb-5">
          <h1>Settings</h1>
        </div>

        <div style="margin-bottom: 200px;">
          <div class="list-group">
            <div class="list-group-item" v-if="DEBUG"><b>Today:</b> {{ today_date_string }}</div>
            <div class="list-group-item" v-if="DEBUG && doc.diet_plan != 'blank'"><b>Last Update Diet On:</b> {{ moment.unix(doc.update_diet_on.seconds).format('dddd, Do MMMM YYYY') }}</div>
            <div class="list-group-item" v-if="DEBUG && doc.diet_plan != 'blank'"><b>Start Diet On:</b> {{ moment.unix(doc.start_diet_on.seconds).format('dddd, Do MMMM YYYY') }}</div>
            <router-link class="list-group-item list-group-item-action text-primary" to="/edit_profile">Edit basic information</router-link>
            <a href="#" class="list-group-item list-group-item-action text-primary" v-on:click="registerNotification" v-if="doc.diet_plan == 'if' && window.Notification && notificationPermission != 'granted'">Register for IF Notifications</a>
            <a href="#" class="list-group-item list-group-item-action text-primary" v-on:click="jumpBackwardADay" v-if="DEBUG">Jump Backward 1 day (For testing purpose)</a>
            <a href="#" class="list-group-item list-group-item-action text-primary" v-on:click="jumpForwardADay" v-if="DEBUG">Jump Forward 1 day (For testing purpose)</a>
            <router-link class="list-group-item list-group-item-action text-danger" to="/logout"><b>Logout</b></router-link>
          </div>
        </div>

        <div class="stickyNavBar fixed-bottom border-top shadow-lg pt-3 pb-3">
          <div class="container">
            <nav class="nav nav-pills nav-justified">
              <router-link class="nav-item nav-link" to="/profile">Profile</router-link>
              <router-link class="nav-item nav-link" to="/diet_plan">Diet Plan</router-link>
              <router-link class="nav-item nav-link" to="/info" v-if="doc.diet_plan != 'blank'">Information</router-link>
              <router-link class="nav-item nav-link active" to="/settings">Settings</router-link>
            </nav>
          </div>
        </div>
      </div>
      `,
      data: function() {
        return {
          today_date_string: today.format('dddd, Do MMMM YYYY'),
          notificationPermission: (window.Notification) ? Notification.permission : 'denied',
        };
      },
      computed: Vuex.mapState(['user', 'doc']),
      methods: {
        registerNotification: function() {
          let that = this;
          if(this.doc.diet_plan != 'if')
            return;

          if(window.Notification && Notification.permission !== 'granted') {
            Notification.requestPermission(function(status) {
              that.notificationPermission = status;
            });
          }
        },
        jumpBackwardADay: function() {
          if(!DEBUG) return;
          this.today_date_string = today.subtract(1, 'day').format('dddd, Do MMMM YYYY');
          return false;
        },
        jumpForwardADay: function() {
          if(!DEBUG) return;
          this.today_date_string = today.add(1, 'day').format('dddd, Do MMMM YYYY');
          return false;
        },
      },
    };

    const ViewFeedbacks = {
      template: `
      <div>
        <div class="mb-5">
          <h1>Feedbacks</h1>
        </div>

        <div class="input-group mb-1">
          <div class="input-group-prepend">
            <span class="input-group-text">From</span>
          </div>
          <input type="text" class="form-control" placeholder="จากวันที่" ref="filter_from_date">
        </div>
        <div class="input-group mb-1">
          <div class="input-group-prepend">
            <span class="input-group-text">To</span>
          </div>
          <input type="text" class="form-control" placeholder="ถึงวันที่" ref="filter_to_date">
        </div>
        <div class="input-group mb-3">
          <button type="button" class="btn btn-primary" v-on:click="fetch">Search</button>
        </div>

        <div class="text-center" v-if="loading">
          <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>

        <div class="text-center" v-show="number_of_feedbacks > -1">
          <p>There are {{ number_of_feedbacks }} feedbacks</p>
          <p v-if="number_of_feedbacks > 0">
            <a :download="feedbacks_base64_csv_filename" :href="feedbacks_base64_csv">Download CSV</a>
          </p>
        </div>

        <div class="stickyNavBar fixed-bottom border-top shadow-lg pt-3 pb-3">
          <div class="container">
            <nav class="nav nav-pills nav-justified">
              <router-link class="nav-item nav-link" to="/profile">Back to Profile</router-link>
            </nav>
          </div>
        </div>
      </div>
      `,
      data: function() {
        return {
          loading: false,
          feedbacks: [],
          number_of_feedbacks: -1,
          feedbacks_base64_csv_filename: '',
          feedbacks_base64_csv: '',
        };
      },
      computed: Vuex.mapState(['user', 'doc']),
      methods: {
        fetch: function() {
          this.feedbacks = [];
          this.loading = true;
          let that = this;

          let query = db.collection('feedbacks');

          let from_date_string = $(this.$refs['filter_from_date']).val();
          let to_date_string = $(this.$refs['filter_to_date']).val();

          let from_date = moment(from_date_string, 'DD/MM/YYYY').isValid() ? moment(from_date_string, 'DD/MM/YYYY') : moment();
          let to_date = moment(to_date_string, 'DD/MM/YYYY').isValid() ? moment(to_date_string, 'DD/MM/YYYY') : moment();

          query = query.where('submitted_on', '>=', from_date.toDate());
          query = query.where('submitted_on', '<=', to_date.toDate());

          query
            .get()
            .then(function(snap) {
              that.number_of_feedbacks = snap.size;

              snap.docs.forEach(doc => {
                that.feedbacks.push(doc.data());
              });

              let csv = that.feedbacks.map(function(v) {
                let csv_lines = [];
                csv_lines[0] = `"username","name","age","gender","height","weight","diet_plan","bmi","feedback","submitted_on"`;
                csv_lines[1] = `"${v.user.username}","${v.doc.name}","${v.doc.age}","${v.doc.gender}","${v.doc.height}","${v.doc.weight}","${v.doc.diet_plan}","${v.doc.bmi[0]}","${v.feedback}","${moment.unix(v.submitted_on.seconds).format('dddd, Do MMMM YYYY')}"`;
                csv_lines[2] = `"","","","","","","","${v.doc.bmi[1]}","",""`;
                csv_lines[3] = `"","","","","","","","${v.doc.bmi[2]}","",""`;

                for(let i = 0; i < 18; i++) {
                  csv_lines[4 + i] = '"","","","","","","","","",""';
                }

                if(v.doc.diet_plan == 'if') {
                  // skip v.doc.fasting_period
                  csv_lines[0] += `,"no calories","no eating"`;
                  for(let i = 0; i < 21; i++) {
                    csv_lines[i + 1] += `,"${v.doc.if_checks[i].no_calories ? 'yes' : 'no'}","${v.doc.if_checks[i].no_eating ? 'yes' : 'no'}"`;
                  }
                } else if(v.doc.diet_plan == 'lc') {
                  csv_lines[0] += `,"unsaturated fat","unsaturated fat","saturated fat","protein"`;
                  for(let i = 0; i < 21; i++) {
                    csv_lines[i + 1] += `,"${v.doc.lc_checks[i].unsaturated_fat_0}","${v.doc.lc_checks[i].unsaturated_fat_1}","${v.doc.lc_checks[i].saturated_fat}","${v.doc.lc_checks[i].protein}"`;
                  }
                } else if(v.doc.diet_plan == 'lf') {
                  csv_lines[0] += `,"carb with fiber","unsaturated fat","protein"`;
                  for(let i = 0; i < 21; i++) {
                    csv_lines[i + 1] += `,"${v.doc.lf_checks[i].carb_with_fiber}","${v.doc.lf_checks[i].unsaturated_fat}","${v.doc.lf_checks[i].protein}"`;
                  }
                }
                return csv_lines.join('%0D%0A');
              });

              if(csv.length > 0)
                that.feedbacks_base64_csv = `data:text/csv;charset=utf-8,\uFEFF${csv.reduce((total, next) => total + '%0D%0A' + next)}`;
              that.feedbacks_base64_csv_filename = `${from_date.format('DDMMYYYY')}-${to_date.format('DDMMYYYY')}.csv`;

              that.loading = false;
            })
            .catch(function(error) {
              console.log(error);
              that.loading = false;
            });
        },
        startBMIOf: function(f) {
          let bmi = f.doc.weight / (f.doc.height * f.doc.height / 10000);
          return Math.round((bmi + Number.EPSILON) * 100) / 100;
        },
        lastBMIOf: function(f) {
          let latestBMI = f.doc.bmi.find((b) => b != 0);
          if(typeof latestBMI === 'undefined') return this.startBMIOf(f);
          return latestBMI;
        },
      },
      mounted: function() {

        $(this.$refs['filter_from_date']).datetimepicker({
          timepicker: false,
          format: 'd/m/Y',
        });
        $(this.$refs['filter_from_date']).val(moment().format('DD/MM/YYYY'));

        $(this.$refs['filter_to_date']).datetimepicker({
          timepicker: false,
          format: 'd/m/Y',
        });
        $(this.$refs['filter_to_date']).val(moment().format('DD/MM/YYYY'));

        this.fetch();
      },
    };

    const routes = [
      { path: '/', component: Login },
      { path: '/logout', component: Logout },
      { path: '/register', component: Register },
      { path: '/profile', component: Profile },
      { path: '/edit_profile', component: EditProfile },
      { path: '/diet_plan', component: DietPlan },
      { path: '/info', component: Information },
      { path: '/settings', component: Settings },
      { path: '/feedbacks', component: ViewFeedbacks },
    ];

    let router = new VueRouter({
      routes,
    });
    router.beforeEach((to, from, next) => {
      if(['/', '/register'].indexOf(to.path) < 0 && store.state.user == null) next({ path: '/' });
      else next();
    })

    let vm = new Vue({
      store,
      router,
    })
    .$mount('#app');
  </script>
</body>

</html>