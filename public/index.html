<!DOCTYPE html>
<html>

<head>
  <!--meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;"-->
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/index.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-firestore.js"></script>
  <title>OBESUM</title>
</head>

<body>
  <div id="app" class="container mt-3">
    <router-view></router-view>
  </div>

  <script type="text/javascript" src="js/vue.min.js"></script>
  <script type="text/javascript" src="js/vue-router.min.js"></script>
  <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="js/moment.js"></script>
  <script type="text/javascript" src="js/popper.min.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>

  <script>

    firebase.initializeApp({
      apiKey: "AIzaSyCyumHT-DtyyUULlC-VNfDvKze0PWSzuqQ",
      authDomain: "obesum-978f6.firebaseapp.com",
      projectId: "obesum-978f6",
      appId: "1:758254882474:web:6c029dede9e22070658ad3",
    });

    var auth = firebase.auth();
    var db = firebase.firestore();

    const Splash = {
      template: `
      `,
      created: function() {
        auth.onAuthStateChanged(function(user) {
          if (user) {
            router.push({ path: '/profile' });
          } else {
            router.push({ path: '/login' });
          }
        });
      },
    };

    const Login = {
      data: function() {
        return {
          username: '',
          password: '',
          loading: false,
          error: '',
        };
      },
      methods: {
        login: function() {
          var that = this;
          this.loading = true;

          auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
          .then(function() {
            auth.signInWithEmailAndPassword(that.username + '@obesum.xyz', that.password)
            .then(function() {
              that.loading = false;
              router.push({ path: '/' });
            })
            .catch(function(error) {
              that.loading = false;
              that.error = error.message;
            });
          })
          .catch(function(error) {
            that.loading = false;
            that.error = error.message;
          });
          return false;
        },
      },
      template: `
      <div>
        <h1>Login</h1>
        <div class="alert alert-danger" role="alert" v-show="error">
          {{ error }}
        </div>
        <form v-on:submit="login">
          <div class="form-group">
            <label for="login-username">Username</label>
            <input type="text" class="form-control" id="login-username" v-model="username">
          </div>
          <div class="form-group">
            <label for="login-password">Password</label>
            <input type="password" class="form-control" id="login-password" v-model="password">
          </div>
          <button type="submit" class="btn btn-primary">Login</button>
          <router-link to="/register">Register a new account</router-link>
        </form>
      </div>
      `,
    };

    const Logout = {
      template: `
      <div>
      <h1>Logging out...</h1>
      <img src="images/spinner.gif">
      </div>
      `,
      created: function() {
        auth.signOut()
        .then(function() {
          router.push({ path: '/' });
        })
        .catch(function(error) {
          console.log(error.message);
        });
      },
    };

    const Register = {
      data: function() {
        return {
          username: '',
          password: '',
          name: '',
          age: 25,
          gender: 'm',
          height: 160,
          weight: 60,
          loading: false,
          success: false,
          error: '',
        };
      },
      methods: {
        register: function() {
          var that = this;
          this.loading = true;

          auth.createUserWithEmailAndPassword(this.username + '@obesum.xyz', this.password)
          .then(function(credential) {

            var user = credential.user;

            db.collection("users").doc(user.uid).set({
              name: that.name,
              age: that.age,
              gender: that.gender,
              height: that.height,
              weight: that.weight,
            })
            .then(function() {
              that.loading = false;
              that.success = true;
            })
            .catch(function(error) {
              that.loading = false;
              that.error = error.message;
            });
          })
          .catch(function(error) {
            that.loading = false;
            that.error = error.message;
          });
          return false;
        },
      },
      template: `
      <div>
        <h1>Register</h1>
        <div class="alert alert-success" role="alert" v-show="success">
          Your account has been registered.
          <router-link to="/login">Login</router-link>
        </div>
        <div class="alert alert-danger" role="alert" v-show="error">
          {{ error }}
        </div>
        <form v-on:submit="register">
          <div class="form-group">
            <label for="register-username">Username</label>
            <input type="text" class="form-control" id="register-username" v-model="username">
          </div>
          <div class="form-group">
            <label for="register-password">Password</label>
            <input type="password" class="form-control" id="register-password" v-model="password">
          </div>
          <div class="form-group">
            <label for="register-name">Name</label>
            <input type="text" class="form-control" id="register-name" v-model="name">
          </div>
          <div class="form-group">
            <label for="register-password">Age</label>
            <input type="number" class="form-control" id="register-age" v-model="age">
          </div>
          <div class="form-group">
            <label for="register-gender">Gender</label>
            <select id="register-gender">
              <option value="m">Male</option>
              <option value="f">Female</option>
            </select>
          </div>
          <div class="form-group">
            <label for="register-height">Height</label>
            <input type="number" class="form-control" id="register-height" v-model="height">
          </div>
          <div class="form-group">
            <label for="register-weight">Weight</label>
            <input type="number" class="form-control" id="register-weight" v-model="weight">
          </div>
          <button type="submit" class="btn btn-primary">Register</button>
          <img src="images/spinner.gif" v-show="loading">
        </form>

        <router-link to="/login">Already have an account? Login</router-link>
      </div>
      `,
    };
    const Profile = {
      template: `
      <div>
        <h1>Profile</h1>
        {{ username }}
        {{ name }}
        {{ age }}
        {{ gender }}
        {{ height }}
        {{ weight }}
        <router-link to="/logout">Logout</router-link>
      </div>
      `,
      data: function() {
        return {
          uid: '',
          username: '',
          name: '',
          age: 25,
          gender: 'm',
          height: 160,
          weight: 60,
        };
      },
      created: function() {
        var that = this;

        auth.onAuthStateChanged(function(user) {
          if (user) {
            that.uid = user.uid;
            that.username = user.email;

            db.collection('users').doc(user.uid).get().then((doc) => {
              var data = doc.data();
              that.name = data.name;
              that.age = data.age;
              that.gender = data.gender;
              that.weight = data.weight;
              that.height = data.height;
            });
          } else {
            router.push({ path: '/' });
          }
        });
      },
    };

    const routes = [
      { path: '/', component: Splash },
      { path: '/login', component: Login },
      { path: '/logout', component: Logout },
      { path: '/register', component: Register },
      { path: '/profile', component: Profile },
    ];

    var router = new VueRouter({
      routes,
    });

    var vm = new Vue({
      router,
    })
    .$mount('#app');
  </script>
</body>

</html>