<!DOCTYPE html>
<html>

<head>
  <!--meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;"-->
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover">
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/index.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
  <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.10.0/firebase-firestore.js"></script>
  <title>OBESUM</title>
</head>

<body>
  <div id="app" class="container pt-3">
    <router-view></router-view>
  </div>

  <script type="text/javascript" src="js/vue.min.js"></script>
  <script type="text/javascript" src="js/vuex.js"></script>
  <script type="text/javascript" src="js/vue-router.min.js"></script>
  <script type="text/javascript" src="js/lodash.min.js"></script>
  <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
  <script type="text/javascript" src="js/moment.js"></script>
  <script type="text/javascript" src="js/popper.min.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/Chart.bundle.min.js"></script>

  <script>

    const USERNAME_SUFFIX = '@obesum.xyz';
    const DIET_PLANS = {
      blank: 'Please select your diet plan',
      if: 'Intermittent Fasting (IF)',
      lc: 'Low-carb (LC)',
      lf: 'Low-fat (LF)',
    };
    const LOADING_MODAL_STRING = 'Please wait while we are saving your information';
    const IF_FASTING_PERIOD_LENGTH = 16;
    const IF_WEEKS_COLOR_PALETTE = ['#d6cbd3', '#eca1a6', '#bdcebe', '#ada397'];

    firebase.initializeApp({
      apiKey: 'AIzaSyCyumHT-DtyyUULlC-VNfDvKze0PWSzuqQ',
      authDomain: 'obesum-978f6.firebaseapp.com',
      projectId: 'obesum-978f6',
      appId: '1:758254882474:web:6c029dede9e22070658ad3',
      databaseURL: "https://obesum-978f6.firebaseio.com",
    });

    var auth = firebase.auth();
    var db = firebase.firestore();

    const store = new Vuex.Store({
      state: {
        error: '',
        user: null,
        doc: null,
        debouncer: null,
      },
      mutations: {
        setUser(state, user) {
          state.user = user;
        },
        setDocument(state, doc) {
          if(state.doc == null) return state.doc = doc;

          if(this.debouncer != null) this.debouncer.cancel();
          this.debouncer = _.debounce(function() {
            $('.loadingModal').modal({
              backdrop: 'static',
              keyboard: false,
              focus: false,
            });

            db.collection('users').doc(state.user.uid).set(doc)
            .then(function() {
              $('.loadingModal').modal('hide');
            });
          }, 200);
          this.debouncer();
        },
      },
      actions: {
        fetchDocument({ commit, state }) {
          return new Promise((resolve, reject) => {
            db.collection('users').doc(state.user.uid).get()
              .then((doc) => {
                var data = doc.data();
                if(typeof data === 'undefined') return;
                commit('setDocument', data);
                resolve();
              })
              .catch((error) => reject(error));
          });
        }
      },
    });

    const Login = {
      template: `
      <div>
        <div class="text-center" v-if="loading">
          <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>
        <div v-else>
          <h1 class="mb-5">Login</h1 class="mb-5">
          <div class="alert alert-danger" role="alert" v-show="error">
            {{ error }}
          </div>
          <form v-on:submit="login">
            <div class="form-group">
              <label for="login-username">Username</label>
              <input type="text" class="form-control" id="login-username" v-model="username">
            </div>
            <div class="form-group">
              <label for="login-password">Password</label>
              <input type="password" class="form-control" id="login-password" v-model="password">
            </div>
            <button class="btn btn-primary">Login</button>
            <router-link to="/register">Register a new account</router-link>
          </form>
        </div>
      </div>
      `,
      data: function() {
        return {
          username: '',
          password: '',
          loading: false,
          error: '',
        };
      },
      methods: {
        login: function() {
          var that = this;
          this.loading = true;

          auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
          .then(function() {
            auth.signInWithEmailAndPassword(that.username + USERNAME_SUFFIX, that.password)
            .catch(function(error) {
              that.loading = false;
              that.error = error.message;
            });
          })
          .catch(function(error) {
            that.loading = false;
            that.error = error.message;
          });
          return false;
        },
      },
      created: function() {
        var that = this;
        this.loading = true;
        auth.onAuthStateChanged(function(user) {
          if(user) {
            store.commit('setUser', user);
            store.dispatch('fetchDocument')
              .then(() => router.push({ path: '/profile' }));
          } else that.loading = false;
        });
      },
    };

    const Logout = {
      template: `
      <div>
        <h1 class="mb-5">Logging out...</h1 class="mb-5">
        <div class="spinner-border" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      `,
      created: function() {
        auth.signOut()
        .then(function() {
          router.push({ path: '/' });
        })
        .catch(function(error) {
          console.log(error);
        });
      },
    };

    const Register = {
      data: function() {
        return {
          username: '',
          password: '',
          name: '',
          age: 25,
          gender: 'm',
          height: 160,
          weight: 60,
          loading: false,
          success: false,
          error: '',
        };
      },
      methods: {
        register: function() {
          var that = this;
          this.loading = true;

          auth.createUserWithEmailAndPassword(this.username + '@obesum.xyz', this.password)
          .then(function(credential) {

            var user = credential.user;
            store.commit('setUser', user);

            db.collection('users').doc(user.uid).set({
              name: that.name,
              age: parseInt(that.age),
              gender: that.gender,
              height: parseInt(that.height),
              weight: parseInt(that.weight),
              diet_plan: 'blank',
              bmi: [0, 0, 0],
              fasting_period: {
                mon: 12,
                tue: 12,
                wed: 12,
                thu: 12,
                fri: 12,
                sat: 12,
                sun: 12,
              },
              if_checks: Array(21).fill().map(n => { return { no_eating: false, no_calories: false }; }),
              start_diet_on: firebase.firestore.FieldValue.serverTimestamp(),
              update_diet_on: firebase.firestore.FieldValue.serverTimestamp(),
            })
            .then(function() {
              that.loading = false;
              that.success = true;
              store.dispatch('fetchDocument');
            })
            .catch(function(error) {
              console.log(error);
              that.loading = false;
              that.error = error.message;
            });
          })
          .catch(function(error) {
            that.loading = false;
            that.error = error.message;
          });
          return false;
        },
      },
      template: `
      <div>
        <h1 class="mb-5">Register</h1 class="mb-5">
        <div class="alert alert-success" role="alert" v-show="success">
          Your account has been registered.
          <router-link to="/login">Login</router-link>
        </div>
        <div class="alert alert-danger" role="alert" v-show="error">
          {{ error }}
        </div>
        <form v-on:submit="register">
          <div class="form-group">
            <label for="register-username">Username</label>
            <input type="text" class="form-control" id="register-username" v-model="username">
          </div>
          <div class="form-group">
            <label for="register-password">Password</label>
            <input type="password" class="form-control" id="register-password" v-model="password">
          </div>
          <div class="form-group">
            <label for="register-name">Name</label>
            <input type="text" class="form-control" id="register-name" v-model="name">
          </div>
          <div class="form-group">
            <label for="register-password">Age</label>
            <input type="number" class="form-control" id="register-age" v-model="age">
          </div>
          <div class="form-group">
            <label for="register-gender">Gender</label>
            <select id="register-gender">
              <option value="m">Male</option>
              <option value="f">Female</option>
            </select>
          </div>
          <div class="form-group">
            <label for="register-height">Height</label>
            <input type="number" class="form-control" id="register-height" v-model="height">
          </div>
          <div class="form-group">
            <label for="register-weight">Weight</label>
            <input type="number" class="form-control" id="register-weight" v-model="weight">
          </div>
          <button class="btn btn-primary">Register</button>
          <div class="spinner-border" role="status" v-show="loading">
            <span class="sr-only">Loading...</span>
          </div>
        </form>

        <router-link to="/login">Already have an account? Login</router-link>
      </div>
      `,
    };
    const Profile = {
      template: `
      <div>
        <h1 class="mb-5">Profile</h1 class="mb-5">
        <div style="margin-bottom: 100px;">
          <div class="row">
            <div class="col-sm-4">
              <h3>{{ username }}</h3>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-4"><h3>Start BMI</h3></div>
            <div class="col-sm">{{ startBMI }}</div>
          </div>
          <div class="row">
            <div class="col-sm-4"><h3>Current BMI</h3></div>
            <div class="col-sm">{{ currentBMI }}</div>
          </div>
          <div class="row">
            <div class="col-sm-4"><h3>Your option</h3></div>
            <div class="col-sm">{{ dietPlan }}</div>
          </div>
          <div class="row">
            <div class="col-sm-4"><router-link to="/logout">Logout</router-link></div>
          </div>
        </div>

        <div class="fixed-bottom border-top bg-white shadow-lg pt-3 pb-3">
          <div class="container">
            <nav class="nav nav-pills nav-justified">
              <router-link class="nav-item nav-link active" to="/profile">Profile</router-link>
              <router-link class="nav-item nav-link" to="/diet_plan">Diet Plan</router-link>
              <router-link class="nav-item nav-link" to="/info" v-if="doc.diet_plan != 'blank'">Information</router-link>
            </nav>
          </div>
        </div>

        <div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true" ref="weightModal">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-body text-center">
                <div class="form-group">
                  <label for="newWeight"><b>Weight</b></label>
                  <input type="number" class="form-control" id="newWeight" v-model="new_weight">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" v-on:click="updateWeight">Submit</button>
              </div>
            </div>
          </div>
        </div>

        <div class="modal fade loadingModal" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-body text-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
                <div><b>{{ LOADING_MODAL_STRING }}</b></div>
                <div class="alert alert-danger" role="alert" v-if="store.state.error != ''">
                  {{ store.state.error }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      `,
      data: function() {
        return {
          new_weight: 0,
        };
      },
      methods: {
        updateWeight: function() {
          var that = this;
          var newBMIIndex = this.doc.bmi.findIndex((b) => b == 0);
          if(newBMIIndex == -1) return;

          var bmi = parseInt(this.new_weight) / (this.doc.height * this.doc.height / 10000);
          this.doc.bmi[newBMIIndex] = Math.round((bmi + Number.EPSILON) * 100) / 100;

          this.doc.update_diet_on = firebase.firestore.FieldValue.serverTimestamp(),
          updateUserDocument(this.doc, function() {
            $(that.$refs['weightModal']).modal('hide');
          });
        },
      },
      computed: {
        username: function() {
          return this.user.email.slice(0, 0 - USERNAME_SUFFIX.length);
        },
        startBMI: function() {
          var bmi = this.doc.weight / (this.doc.height * this.doc.height / 10000);
          return Math.round((bmi + Number.EPSILON) * 100) / 100;
        },
        currentBMI: function() {
          var latestBMI = this.doc.bmi.find((b) => b != 0);
          if(typeof latestBMI === 'undefined') return this.startBMI;
          return latestBMI;
        },
        dietPlan: function() {
          return DIET_PLANS[this.doc.diet_plan];
        },
        lastUpdated: function() {
          return moment.unix(this.doc.update_diet_on.seconds).format();
        },
        ...Vuex.mapState(['user', 'doc']),
      },
      mounted: function() {
        if(moment().isSameOrAfter(moment.unix(this.doc.update_diet_on.seconds).add(7, 'days'))) {
          $(this.$refs['weightModal']).modal({
            backdrop: 'static',
            keyboard: false,
            focus: false,
          });
        }
      },
    };
    const DietPlan = {
      template: `
      <div>
        <h1 class="mb-5">{{ doc.diet_plan == 'blank' ? 'Diet Plan' : DIET_PLANS[doc.diet_plan] }}</h1 class="mb-5">
        <div v-if="doc.diet_plan == 'blank'">
          <div class="card-deck">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">IF</h5>
                <p class="card-text">การกินแบบจำกัดช่วงเวลา ซึ่งมีช่วงที่กินได้ [eating] กับ กินไม่ได้ [fasting] จะทำให้การเผาผลาญเปลี่ยนไป</p>
              </div>
              <div class="card-footer">
                <a href="#" class="btn btn-primary" v-on:click="doc.diet_plan = 'if'">Select</a>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <h5 class="card-title">LC</h5>
                <p class="card-text">การกินอาหารแบบกินคาร์โบไฮเดรตให้น้อยลง แต่อาจจะกินไขมันมากขึ้นแทน (ketogenic)</p>
              </div>
              <div class="card-footer">
                <a href="#" class="btn btn-primary" v-on:click="doc.diet_plan = 'lc'">Select</a>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <h5 class="card-title">LF</h5>
                <p class="card-text">รูปแบบการกินที่เรากินไขมันให้น้อย แต่กินคาร์โบไฮเดรตที่มีไฟเบอร์เยอะขึ้น</p>
              </div>
              <div class="card-footer">
                <a href="#" class="btn btn-primary" v-on:click="doc.diet_plan = 'lf'">Select</a>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 100px;" v-else-if="doc.diet_plan == 'if'">
          <div class="row">
            <canvas ref="ifChart" width="400" height="400" style="width: 400px !important; height: 400px !important;"></canvas>
          </div>
          <div class="row mt-3">
            <div class="w-100 overflow-auto">
              <table class="table mb-0 text-center">
                <thead>
                  <tr>
                    <th></th>
                    <th v-for="(d, i) in twentyOneDays" :style="{ backgroundColor: IF_WEEKS_COLOR_PALETTE[Math.floor(i / 7)] }">
                      {{ d.format('ddd') }}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th>No eating</th>
                    <td v-for="(d, i) in twentyOneDays" :style="{ backgroundColor: IF_WEEKS_COLOR_PALETTE[Math.floor(i / 7)] }">
                      <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" :id="'no_eating-' + i" :disabled="shouldBeDisabled(d)" v-on:change="ifTick" v-model="doc.if_checks[i]['no_eating']">
                        <label class="custom-control-label" :for="'no_eating-' + i"></label>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <th>No calories</th>
                    <td v-for="(d, i) in twentyOneDays" :style="{ backgroundColor: IF_WEEKS_COLOR_PALETTE[Math.floor(i / 7)] }">
                      <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" :id="'no_calories-' + i" :disabled="shouldBeDisabled(d)" v-on:change="ifTick" v-model="doc.if_checks[i]['no_calories']">
                        <label class="custom-control-label" :for="'no_calories-' + i"></label>
                      </div>
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <th></th>
                    <td v-for="i in 3" colspan="7">
                      <b>Week {{ i }}</b>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <div class="fixed-bottom border-top bg-white shadow-lg pt-3 pb-3">
          <div class="container">
            <nav class="nav nav-pills nav-justified">
              <router-link class="nav-item nav-link" to="/profile">Profile</router-link>
              <router-link class="nav-item nav-link active" to="/diet_plan">Diet Plan</router-link>
              <router-link class="nav-item nav-link" to="/info" v-if="doc.diet_plan != 'blank'">Information</router-link>
            </nav>
          </div>
        </div>

        <div class="modal fade loadingModal" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-body text-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
                <div><b>{{ LOADING_MODAL_STRING }}</b></div>
                <div class="alert alert-danger" role="alert" v-if="store.state.error != ''">
                  {{ store.state.error }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      `,
      data: function() {
        return {
          twentyOneDays: [],
        };
      },
      created: function() {
        this.twentyOneDays = Array(21).fill().map((n, i) => moment.unix(this.doc.start_diet_on.seconds).add(i, 'days'));
      },
      methods: {
        ifTick: function(evt) {
          store.commit('setDocument', this.doc);
        },
        shouldBeDisabled: function(d) {
          return d.isSameOrBefore(moment(), 'day') ? false : true;
        },
      },
      computed: {
        ...Vuex.mapState(['user', 'doc']),
      },
      mounted: function() {
        if(this.doc.diet_plan == 'if')
        {
          var ctx = this.$refs['ifChart'].getContext('2d');
          var myDoughnutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              datasets: [{
                data: [IF_FASTING_PERIOD_LENGTH, 24 - IF_FASTING_PERIOD_LENGTH],
                backgroundColor: ['red', 'blue'],
              }],
            },
            options: {
              rotation: -1 * (this.doc.fasting_period[moment().format('ddd').toLowerCase()] / 12) * Math.PI,
              legends: { display: false },
              tooltips: { enabled: false },
              responsive: true,
              maintainAspectRatio: false,
            },
          });
        }
      },
    };
    const Information = {
      template: `
      <div>
        <h1 class="mb-5">{{ doc.diet_plan == 'blank' ? 'Diet Plan' : DIET_PLANS[doc.diet_plan] }} Information</h1 class="mb-5">

        <div style="margin-bottom: 100px;" v-if="doc.diet_plan == 'if'">
          <div class="row" v-for="dow in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']" :key="dow">
            <div class="col-sm-2">
              <h3>{{ dow }}</h3>
            </div>
            <div class="col-sm">
              <ul class="pagination">
                <li class="page-item">
                  <a class="page-link" href="#" v-on:click="decreaseHour(dow)">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                <li class="page-item disabled">
                  <a class="page-link" href="#">
                    {{ fastingPeriodStart(dow) }}.00 - {{ fastingPeriodEnd(dow) }}.00
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="#" v-on:click="increaseHour(dow)">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="fixed-bottom border-top bg-white shadow-lg pt-3 pb-3">
          <div class="container">
            <nav class="nav nav-pills nav-justified">
              <router-link class="nav-item nav-link" to="/profile">Profile</router-link>
              <router-link class="nav-item nav-link" to="/diet_plan">Diet Plan</router-link>
              <router-link class="nav-item nav-link active" to="/info" v-if="doc.diet_plan != 'blank'">Information</router-link>
            </nav>
          </div>
        </div>

        <div class="modal fade loadingModal" tabindex="-1" role="dialog" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-body text-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
                <div><b>{{ LOADING_MODAL_STRING }}</b></div>
                <div class="alert alert-danger" role="alert" v-if="store.state.error != ''">
                  {{ store.state.error }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      `,
      methods: {
        decreaseHour: function(dow) {
          var newHour = this.doc.fasting_period[dow.toLowerCase()] - 1;
          if(newHour < 0) newHour = 23;
          this.doc.fasting_period[dow.toLowerCase()] = newHour;
          store.commit('setDocument', this.doc);
          return false;
        },
        increaseHour: function(dow) {
          var newHour = this.doc.fasting_period[dow.toLowerCase()] + 1;
          if(newHour > 23) newHour = 0;
          this.doc.fasting_period[dow.toLowerCase()] = newHour;
          store.commit('setDocument', this.doc);
          return false;
        },
        fastingPeriodStart: function(dow) {
          var start = this.doc.fasting_period[dow.toLowerCase()];
          return start < 10 ? `0${start}` : `${start}`;
        },
        fastingPeriodEnd: function(dow) {
          var end = this.doc.fasting_period[dow.toLowerCase()] + (24 - IF_FASTING_PERIOD_LENGTH);
          if(end > 23) end -= 24;
          return end < 10 ? `0${end}` : `${end}`;
        },
      },
      computed: Vuex.mapState(['user', 'doc']),
    };

    const routes = [
      { path: '/', component: Login },
      { path: '/logout', component: Logout },
      { path: '/register', component: Register },
      { path: '/profile', component: Profile },
      { path: '/diet_plan', component: DietPlan },
      { path: '/info', component: Information },
    ];

    var router = new VueRouter({
      routes,
    });
    router.beforeEach((to, from, next) => {
      if(['/'].indexOf(to.path) < 0 && store.state.user == null) next({ path: '/' });
      else next();
    })

    var vm = new Vue({
      store,
      router,
    })
    .$mount('#app');
  </script>
</body>

</html>